<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" href="njas.css">
</head>
<body>
    <main>
        <div class="menuBar">
            <do-logo></do-logo>
        </div>
        <!-- 
        <div class="EditorContainer">
            <div class="Editor">
                <div class="EditorParagraph" id="editorParag"></div>
            </div>
        </div> -->
        <!-- <div id="dragAndDrop" class="dragAndDrop">
            <p style="pointer-events: none;">Przeciągnij i upuść tutaj plik Worda, aby rozpocząć.</p>
        </div> -->

        <drag-and-drop></drag-and-drop>
    </main>

    <template id="dialogBodyControl">
        <div class="bv">
            <span>Nazwa Pliku</span>
            <input type="text" id="nameFile" class="filePath">
        </div>
        <div class="bc">
            <span>Ilość Plików</span>
            <div class="countC">
                <pre contenteditable="true">0</pre><p>/500</p>
            </div>
        </div>
        <button id="nextButtonn" class="nextButton">Dalej</button>
    </template>

    <template id="dialogStartTemplate">
        <div id="dialogStart" class="dialogStart">
            <div class="dialogHeader">
                <div class="closeDlg" id="bClose"><img src="./img/close.svg" alt="close"></div>
            </div>
            <div class="dialogSelectHeader">
                <div class="dialogSelectHeaderItem" id="settings">Ustawienia</div>
                <div class="dialogSelectHeaderItem" id="countFile">Ile plików</div>
            </div>
            <div class="dialogBody" id="dBody">

            </div>
        </div>
    </template>
    <script src="Screen/DOComponents.js" async></script>
    <script src="nic2.js"></script>
    <script>
        let pars = new DOMParser();
        let ff = null;
        let dragg = document.querySelector('drag-and-drop');

        function createWorkNavBar(root){
            const workNav = document.createElement('work-nav');
            const fontContainer = document.createElement('div');
            fontContainer.classList.add('Font');
            fontContainer.textContent = "Czcionka"
            const fontSizeButtons = document.createElement('font-size-buttons');

            const buttonBold = document.createElement('button');
            buttonBold.classList.add('boldBTN');
            const btnImg = document.createElement('img');
            btnImg.src = './img/bold32x32.svg';
            btnImg.alt = 'bold';
            buttonBold.append(btnImg)

            const buttonItalic = document.createElement('button');
            buttonItalic.classList.add('boldBTN');
            const btnImgItalic = document.createElement('img');
            btnImgItalic.src = './img/italic.svg';
            btnImgItalic.alt = 'bold';
            buttonItalic.append(btnImgItalic)

            const buttonUnderline = document.createElement('button');
            buttonUnderline.classList.add('boldBTN');
            const btnImgUnderline = document.createElement('img');
            btnImgUnderline.src = './img/underline.svg';
            btnImgUnderline.alt = 'bold';
            buttonUnderline.append(btnImgUnderline)

            workNav.append(fontContainer, fontSizeButtons, buttonBold, buttonItalic, buttonUnderline);
            root.append(workNav);
        }

        function createEdytor(root2){
            const edytorContainer = document.createElement('div');
            edytorContainer.classList.add('EditorContainer');
            const edytor = document.createElement('div');
            edytor.classList.add('Editor');

            if(ff !== null){
                // console.log(ff);

                let ffLength = ff.body.length;
                for(let fm = 0; fm < ffLength; fm++){
                    if(ff.body[fm].type === 'Paragraph'){
                        // console.log(ff.body[fm]);
                        let edytorParagraph = document.createElement('div');
                        edytorParagraph.classList.add('EditorParagraph');
                        edytorParagraph.style.alignItems = "center";

                        let runss = ff.body[fm].runs;
                        for(let d = 0; d < runss.length; d++){
                            let pRun = document.createElement('pre');
                            pRun.contentEditable = true;
                            pRun.style.display = 'inline-block';
                            pRun.style.margin = "0";
                            if(runss[d].oldValues !== undefined){
                                pRun.textContent = runss[d].oldValues;
                                if(runss[d].rPr.color !== '#undefined' || runss[d].rPr.color !== 'null'){
                                    pRun.style.color = runss[d].rPr.color
                                }
                                
                                edytorParagraph.append(pRun);
                            }
                        }

                        edytor.append(edytorParagraph);
                    }                    
                }
            }
            edytorContainer.append(edytor)

            root2.append(edytorContainer);
        }

        function PAndR(mlElement){
            let parag = {
                type: "Paragraph",
                pPr: {
                    pStyle: mlElement.querySelector('pPr').querySelector('pStyle')?.getAttribute("w:val"),
                    rPr: {
                        sz: Number.parseInt(mlElement.querySelector('pPr')?.querySelector('rPr')?.querySelector('sz')?.getAttribute("w:val")) || null,
                        szCs: Number.parseInt(mlElement.querySelector('pPr')?.querySelector('rPr')?.querySelector('szCs')?.getAttribute("w:val")) || null
                    }
                },
                runs: []
            }
            for(rb = 0; rb < mlElement.querySelectorAll('r').length; rb++){
                const runn = {
                    type: "Run",
                    rPr: {
                        fontSize: Number.parseInt(mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("sz")?.getAttribute("w:val")) || Number.parseInt(mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("szCs")?.getAttribute("w:val")),
                        bold: mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("b") || mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("bCs") ? true : false,
                        italic: mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("i") || mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("iCs") ? true : false,
                        strike: mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("strike") || mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("dstrike") ? true : false,
                        underline: mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("u") ? true : false,
                        color: ""
                    },
                    oldValues: [] | ''
                }

                if (mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val").startsWith("#")) {
                    runn.rPr.color = mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val");
                } else {
                    runn.rPr.color = `#${mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val")}` || 'null';
                }
                if (mlElement.querySelectorAll('r')[rb]?.querySelectorAll("t").length > 1) {
                    mlElement.querySelectorAll('r')[rb]?.querySelectorAll("t")?.forEach(t => {
                        runn.oldValues.push(t.textContent);
                    });
                } else {
                    runn.oldValues = mlElement.querySelectorAll('r')[rb]?.querySelector('t')?.textContent;
                }
                parag.runs.push(runn);
            }
            return parag;
        }

        function T(tElement){
            let tablee = {
                type: 'Table',
                tblPr: {
                    tblW: {
                        width: tElement?.querySelector('tblPr').querySelector('tblW').getAttribute('w:w'),
                        type: tElement?.querySelector('tblPr').querySelector('tblW').getAttribute('w:type') === 'dxa' ? "DXA" : "null"
                    },
                    jc: tElement?.querySelector('tblPr').querySelector('jc').getAttribute('w:val'),
                    tblInd: {
                        width: tElement?.querySelector('tblPr').querySelector('tblInd').getAttribute('w:w'),
                        type: tElement?.querySelector('tblPr').querySelector('tblInd').getAttribute('w:type') === 'dxa' ? "DXA" : "null"
                    },
                    tblLayout: {
                        type: tElement?.querySelector('tblPr').querySelector('tblLayout').getAttribute('w:type') || "null"
                    },
                    tblCellMar: {
                        top: {
                            width: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('top')?.getAttribute('w:w'),
                            type: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('top')?.getAttribute('w:type') === 'dxa' ? "DXA" : "null"
                        },
                        left: {
                            width: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('left')?.getAttribute('w:w'),
                            type: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('left')?.getAttribute('w:type') === 'dxa' ? "DXA" : "null"
                        },
                        bottom: {
                            width: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('bottom')?.getAttribute('w:w'),
                            type: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('bottom')?.getAttribute('w:type') === 'dxa' ? "DXA" : "null"
                        },
                        right: {
                            width: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('right')?.getAttribute('w:w'),
                            type: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('right')?.getAttribute('w:type') === 'dxa' ? "DXA" : "null"
                        }
                    }
                },
                tblGrid: {
                    gridCols: []
                },
                tbr: [],
            }

            let tblGridColumns =  tElement?.querySelector('tblGrid').childNodes;
            for(let tblGC = 0; tblGC < tblGridColumns.length; tblGC++){
                let gridCol = {
                    width: Number.parseInt(tblGridColumns[tblGC].getAttribute('w:w'))
                };
                tablee.tblGrid.gridCols.push(gridCol);
            }

            let tRows = tElement?.querySelectorAll('tr');
            for(let tR = 0; tR < tRows.length; tR++){
                let tableRow = {
                    trPr: tRows[tR]?.querySelector('trPr') || null,
                    tcols: [],
                }

                if(tRows[tR].querySelector('tc') !== null){
                    let tc = {
                        tcPr: {
                            tcW: {
                                width: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcW')?.getAttribute('w:w')),
                                type: tRows[tR]?.querySelector('tcPr')?.querySelector('tcW')?.getAttribute('w:type')
                            },
                            tcBorders: {
                                top: {
                                    val: tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('top')?.getAttribute('w:val'),
                                    sz: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('top')?.getAttribute('w:sz')),
                                    space: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('top')?.getAttribute('w:space')),
                                    color: tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('top')?.getAttribute('w:color')
                                },
                                left: {
                                    val: tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('left')?.getAttribute('w:val'),
                                    sz: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('left')?.getAttribute('w:sz')),
                                    space: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('left')?.getAttribute('w:space')),
                                    color: tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('left')?.getAttribute('w:color')
                                },
                                bottom: {
                                    val: tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('bottom')?.getAttribute('w:val'),
                                    sz: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('bottom')?.getAttribute('w:sz')),
                                    space: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('bottom')?.getAttribute('w:space')),
                                    color: tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('bottom')?.getAttribute('w:color')
                                },
                            }
                        },
                        p: []
                    }

                    let tColumns = tRows[tR].querySelectorAll('tc');
                    for(let tcc = 0; tc < tColumns.length; tc++){
                        let tcp = tColumns[tcc].querySelectorAll('p');
                        for(let tccp = 0; tccp < tcp.length; tccp++){
                            
                            let TableColumnParagraph = {
                                type: "Paragraph",
                                pPr: {
                                    pStyle: tcp[tccp].querySelector('pPr').querySelector('pStyle')?.getAttribute("w:val"),
                                    rPr: {
                                        sz: Number.parseInt(tcp[tccp].querySelector('pPr')?.querySelector('rPr')?.querySelector('sz')?.getAttribute("w:val")) || null,
                                        szCs: Number.parseInt(tcp[tccp].querySelector('pPr')?.querySelector('rPr')?.querySelector('szCs')?.getAttribute("w:val")) || null
                                    }
                                },
                                runs: []
                            }

                            let tcpr = tcp[tccp].querySelectorAll('r');
                            for(let tcprr = 0; tcprr < tcpr.length; tcprr++){
                                const runn = {
                                    type: "Run",
                                    rPr: {
                                        fontSize: Number.parseInt(tcpr[tcprr]?.querySelector("rPr")?.querySelector("sz")?.getAttribute("w:val")) || Number.parseInt(tcpr[tcprr]?.querySelector("rPr")?.querySelector("szCs")?.getAttribute("w:val")),
                                        bold: tcpr[tcprr]?.querySelector("rPr")?.querySelector("b") || r?.querySelector("rPr")?.querySelector("bCs") ? true : false,
                                        italic: tcpr[tcprr]?.querySelector("rPr")?.querySelector("i") || r?.querySelector("rPr")?.querySelector("iCs") ? true : false,
                                        strike: tcpr[tcprr]?.querySelector("rPr")?.querySelector("strike") || r?.querySelector("rPr")?.querySelector("dstrike") ? true : false,
                                        underline: tcpr[tcprr]?.querySelector("rPr")?.querySelector("u") ? true : false,
                                        color: ""
                                    },
                                    oldValues: [] | ''
                                }

                                if (tcpr[tcprr]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val").startsWith("#")) {
                                    runn.rPr.color = tcpr[tcprr]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val");
                                } else if (tcpr[tcprr]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val") === undefined || tcpr[tcprr]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val") === null) {
                                    runn.rPr.color = "null";
                                } else {
                                    runn.rPr.color = `#${tcpr[tcprr]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val")}`;
                                }
                                if (tcpr[tcprr]?.querySelectorAll("t").length > 1) {
                                    tcpr[tcprr]?.querySelectorAll("t")?.forEach(t => {
                                        runn.oldValues.push(t.textContent);
                                    });
                                } else {
                                    runn.oldValues = tcpr[tcprr]?.querySelector('t')?.textContent;
                                }

                                TableColumnParagraph.runs.push(runn);
                            }
                            tc.p.push(TableColumnParagraph);
                        }
                    }
                    tableRow.tcols.push(tc);
                }
                tablee.tbr.push(tableRow);
            }        
            return tablee  
        }

        function start(path, data) {
            let Documentt = {
                fileName: path.name,
                body: []
            }
            let mlDom = pars.parseFromString(data, 'application/xml');

            let mlDomBody = mlDom.querySelector("body");
            let mldomElements = mlDomBody.childNodes;

            for(let cN = 0; cN < mldomElements.length; cN++){
                if(mldomElements[cN].localName === 'p'){
                    Documentt.body.push(PAndR(mldomElements[cN]));
                } else if(mldomElements[cN].localName === 'tbl'){
                    Documentt.body.push(T(mldomElements[cN]));
                }    
            }
            let documenttJSON = JSON.stringify(Documentt);

            mFile.fileSystem.writeFile(`${path.name}.json`, documenttJSON, (err) => {
                if (err) console.error(err);
            });

            ff = Documentt;
        }

        function runningSuperEditor(filess, htmElement){
            let editorTempp = document.querySelector('#dialogStartTemplate').content.cloneNode(true);
            let dbControl = document.querySelector('#dialogBodyControl').content.cloneNode(true);
            try{
                if(filess.length == 1){
                    if(mFile.fileSystem.existsSync(`docxs/${filess[0].name}`)){
                        editorTempp.querySelector('#bClose').addEventListener('click', (e)=>{
                            e.path[3].remove();
                        })
                        editorTempp.querySelector('#countFile').setAttribute("activee", "");
                        editorTempp.querySelector('#dBody').append(dbControl);
                        editorTempp.querySelector('#dBody').querySelector('#nextButtonn').addEventListener('click', ()=>{
                            mFile.fileSystem.readFile(`docxs/${filess[0].name}/word/document.xml`, 'utf8', (err, buff) => {
                                if (err) { return console.log(err)}
                                start(filess[0], buff);
                                document.querySelector('#dialogStart').remove();
                                dragg.remove();
                                createWorkNavBar(document.querySelector('main'));
                                createEdytor(document.querySelector('main'))
                            });
                        })
                        editorTempp.querySelector('#nameFile').value = `${filess[0].name}`;
                        document.querySelector('main').append(editorTempp);
                    }else{
                        mFile.de(`${filess[0].path}`, `docxs/${filess[0].name}`).then(fl => {
                            fl.forEach(l => {
                                if (l.path == "word/document.xml") {
                                    mFile.fileSystem.readFile(`docxs/${l.name}/${l.path}`);
                                }
                            })
                        })
                    }
                }
            }catch(r){
                console.log(r)
            }
        }

        dragg.addEventListener('dd', (e)=>{
            runningSuperEditor(e.detail.f, document.querySelector("main"));
        })

    </script>
</body>
</html>