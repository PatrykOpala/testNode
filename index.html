<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" href="njas.css">
</head>
<body>
    <main>
        <div class="menuBar">
            <do-logo></do-logo>
        </div>
        <drag-and-drop></drag-and-drop>
    </main>
    <script src="Screen/DOComponents.js" async></script>
    <script src="nic2.js"></script>
    <script>
        let pars = new DOMParser();
        let ff = null;
        let dragg = document.querySelector('drag-and-drop');
        let vbcx = document.querySelector('main');
        const inst = new InstanceMain();

        async function vcccccccc(te){
            let t = await AsyncTableTemplate(te);
            return t;
        }

        function createWorkNavBar(root){
            const workNav = document.createElement('work-nav');
            const fontContainer = document.createElement('div');
            fontContainer.classList.add('Font');
            fontContainer.textContent = "Czcionka";
            const fontSizeButtons = document.createElement('font-size-buttons');

            const buttonBold = document.createElement('button');
            buttonBold.classList.add('boldBTN');
            const btnImg = document.createElement('img');
            btnImg.setAttribute("src", "./img/bold32x32.svg");
            btnImg.setAttribute("alt", "bold");
            buttonBold.append(btnImg)

            const buttonItalic = document.createElement('button');
            buttonItalic.classList.add('boldBTN');
            const btnImgItalic = document.createElement('img');
            btnImgItalic.setAttribute("src", "./img/italic.svg");
            btnImgItalic.setAttribute("alt", "bold");
            buttonItalic.append(btnImgItalic)

            const buttonUnderline = document.createElement('button');
            buttonUnderline.classList.add('boldBTN');
            const btnImgUnderline = document.createElement('img');
            btnImgItalic.setAttribute("src", "./img/underline.svg");
            btnImgItalic.setAttribute("alt", "bold");
            buttonUnderline.append(btnImgUnderline)

            workNav.append(fontContainer, fontSizeButtons, buttonBold, buttonItalic, buttonUnderline);
            root.append(workNav);
        }

        function createEdytor(root2){
            if(ff.body[fm].type === 'Table'){
                let tableElement = document.createElement('table');
                // tableElement.style.border = "1px solid red";

                for(let cvb = 0; cvb < ff.body[fm].tbr.length; cvb++){
                    for(let tr = 0; tr < ff.body[fm].tbr[cvb].tcols.length; tr++){
                        let tableRowElement = document.createElement('tr');
                        tableRowElement.style.padding = "5px";
                        tableRowElement.style.border = "2px solid yellow";

                        // for(let td = 0; td < ff.body[fm].tbr[cvb].tcols[tr].length; td++){
                        //     console.log("tableTDElement");
                        //     tableTDElement = document.createElement('td');
                        //     for(let tdP = 0; tdP < ff.body[fm].tbr[cvb].tcols[tr].p[td]; tdP++){
                        //         console.log("tableParagraph");
                        //         let tableParagraph = document.createElement('div');
                        //         tableParagraph.classList.add('EditorParagraph');
                        //         tableParagraph.style.alignItems = "center";

                        //             let runss = ff.body[fm].tbr[cvb].tcols[tr].p[td].runs[tdP].length;
                        //             for(let d = 0; d < runss.length; d++){
                        //                 let pRun = document.createElement('pre');
                        //                 pRun.contentEditable = true;
                        //                 pRun.style.display = 'inline-block';
                        //                 pRun.style.margin = "0";
                        //                 if(runss[d].oldValues !== undefined){
                        //                     pRun.textContent = runss[d].oldValues;
                        //                     if(runss[d].rPr.color !== '#undefined' || runss[d].rPr.color !== 'null'){
                        //                         pRun.style.color = runss[d].rPr.color
                        //                     }
                        //                     tableParagraph.append(pRun);
                        //                 }
                        //             }

                        //         tableTDElement.append(edytorParagraph);
                        //     }
                        //     console.log(tableTDElement);
                        //     tableRowElement.append(tableTDElement);
                        // }
                        tableElement.append(tableRowElement);
                    }
                }
                edytor.append(tableElement);
            }
        }

        function PAndR(mlElement, rt){
            let edytorParagraph = document.createElement('div');
                edytorParagraph.classList.add('EditorParagraph');
                edytorParagraph.style.alignItems = "center";

            for(rb = 0; rb < mlElement.querySelectorAll('r').length; rb++){
                let pRun = document.createElement('pre');
                pRun.contentEditable = true;
                pRun.style.display = 'inline-block';
                pRun.style.margin = '0';
                pRun.style.fontSize = `${Number.parseInt(mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("sz")?.getAttribute("w:val")) 
                || Number.parseInt(mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("szCs")?.getAttribute("w:val"))}pt`;

                if(mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("sz")?.getAttribute("w:val") !== undefined){
                    pRun.setAttribute("do-font-size", `${mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("sz")?.getAttribute("w:val")}`);
                }
                
                if(mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("b") 
                || mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("bCs")){
                    pRun.style.fontWeight = 'bold';
                    pRun.setAttribute("do-font-weight", "bold");
                }

                if(mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("i") 
                || mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("iCs")){
                    pRun.style.fontStyle = 'italic';
                    pRun.setAttribute("do-font-style", "italic");
                }

                if(mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("u")){
                    pRun.style.textDecoration = 'underline';
                    pRun.setAttribute("do-text-decoration", "underline");
                }

                if(mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("strike") || mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("dstrike")){
                    pRun.style.textDecoration = "underline line-through";
                    pRun.setAttribute("do-text-decoration", "underline line-through");
                }
                mlElement.querySelectorAll('r')[rb]?.querySelectorAll("t")?.forEach(t => {
                    pRun.setAttribute('oldValue', t.textContent);
                    pRun.textContent = t.textContent;
                });
                if (mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val").startsWith("#")) {
                    pRun.style.color = `${mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val")}`;
                    pRun.setAttribute("do-color", `${mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val")}`);
                } else {
                    pRun.style.color = `#${mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val")}` || 'null';
                    pRun.setAttribute("do-color", `#${mlElement.querySelectorAll('r')[rb]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val")}` || 'null');
                }
                edytorParagraph.append(pRun);
            }
            edytorParagraph.addEventListener("click", (event)=>{
                if(event.target.localName === "pre"){
                    new EdytorDialog(vbcx, event.target);
                }
            });
            rt.append(edytorParagraph);
        }

        function T(tElement, rt2){
            // 6,944444444444444e-4
            let tablee = {
                type: 'Table',
                tblPr: {
                    tblW: {
                        width: tElement?.querySelector('tblPr').querySelector('tblW').getAttribute('w:w'),
                        type: ""
                    },
                    jc: tElement?.querySelector('tblPr').querySelector('jc').getAttribute('w:val'),
                    tblInd: {
                        width: tElement?.querySelector('tblPr').querySelector('tblInd').getAttribute('w:w'),
                        type: tElement?.querySelector('tblPr').querySelector('tblInd').getAttribute('w:type') === 'dxa' ? "DXA" : "null"
                    },
                    tblLayout: {
                        type: tElement?.querySelector('tblPr').querySelector('tblLayout').getAttribute('w:type') || "null"
                    },
                    tblCellMar: {
                        top: {
                            width: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('top')?.getAttribute('w:w'),
                            type: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('top')?.getAttribute('w:type') === 'dxa' ? "DXA" : "null"
                        },
                        left: {
                            width: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('left')?.getAttribute('w:w'),
                            type: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('left')?.getAttribute('w:type') === 'dxa' ? "DXA" : "null"
                        },
                        bottom: {
                            width: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('bottom')?.getAttribute('w:w'),
                            type: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('bottom')?.getAttribute('w:type') === 'dxa' ? "DXA" : "null"
                        },
                        right: {
                            width: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('right')?.getAttribute('w:w'),
                            type: tElement?.querySelector('tblPr')?.querySelector('tbCellMar')?.querySelector('right')?.getAttribute('w:type') === 'dxa' ? "DXA" : "null"
                        }
                    }
                },
                tblGrid: {
                    gridCols: []
                },
                tbr: [],
            }

            if(tElement?.querySelector('tblPr').querySelector('tblW').getAttribute('w:type') === 'dxa'){
                tablee.tblPr.tblW.type = tElement?.querySelector('tblPr').querySelector('tblW').getAttribute('w:type')
            }else if(tElement?.querySelector('tblPr').querySelector('tblW').getAttribute('w:type') === 'pct'){
                tablee.tblPr.tblW.type = tElement?.querySelector('tblPr').querySelector('tblW').getAttribute('w:type')
            }else{
                tablee.tblPr.tblW.type = ""
            }
            
            let table = document.createElement('table');
            table.style.border = "1px solid red";

            let tblGridColumns =  tElement?.querySelector('tblGrid').childNodes;
            for(let tblGC = 0; tblGC < tblGridColumns.length; tblGC++){
                let gridCol = {
                    width: Number.parseInt(tblGridColumns[tblGC].getAttribute('w:w'))
                };
                tablee.tblGrid.gridCols.push(gridCol);
            }

            let tRows = tElement?.querySelectorAll('tr');
            for(let tR = 0; tR < tRows.length; tR++){
                let tableRow = {
                    trPr: tRows[tR]?.querySelector('trPr') || null,
                    tcols: [],
                }

                if(tRows[tR].querySelector('tc') !== null){
                    let tc = {
                        tcPr: {
                            tcW: {
                                width: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcW')?.getAttribute('w:w')),
                                type: tRows[tR]?.querySelector('tcPr')?.querySelector('tcW')?.getAttribute('w:type')
                            },
                            tcBorders: {
                                top: {
                                    val: tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('top')?.getAttribute('w:val'),
                                    sz: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('top')?.getAttribute('w:sz')),
                                    space: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('top')?.getAttribute('w:space')),
                                    color: tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('top')?.getAttribute('w:color')
                                },
                                left: {
                                    val: tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('left')?.getAttribute('w:val'),
                                    sz: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('left')?.getAttribute('w:sz')),
                                    space: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('left')?.getAttribute('w:space')),
                                    color: tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('left')?.getAttribute('w:color')
                                },
                                bottom: {
                                    val: tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('bottom')?.getAttribute('w:val'),
                                    sz: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('bottom')?.getAttribute('w:sz')),
                                    space: Number.parseInt(tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('bottom')?.getAttribute('w:space')),
                                    color: tRows[tR]?.querySelector('tcPr')?.querySelector('tcBorders')?.querySelector('bottom')?.getAttribute('w:color')
                                },
                            }
                        },
                        p: []
                    }

                    let tColumns = tRows[tR].querySelectorAll('tc');
                    for(let tcc = 0; tc < tColumns.length; tc++){
                        let tcp = tColumns[tcc].querySelectorAll('p');
                        for(let tccp = 0; tccp < tcp.length; tccp++){
                            
                            let TableColumnParagraph = {
                                type: "Paragraph",
                                pPr: {
                                    pStyle: tcp[tccp].querySelector('pPr').querySelector('pStyle')?.getAttribute("w:val"),
                                    rPr: {
                                        sz: Number.parseInt(tcp[tccp].querySelector('pPr')?.querySelector('rPr')?.querySelector('sz')?.getAttribute("w:val")) || null,
                                        szCs: Number.parseInt(tcp[tccp].querySelector('pPr')?.querySelector('rPr')?.querySelector('szCs')?.getAttribute("w:val")) || null
                                    }
                                },
                                runs: []
                            }
                            console.log(tcp[tccp].querySelectorAll('r'))
                            let tcpr = tcp[tccp].querySelectorAll('r');
                            for(let tcprr = 0; tcprr < tcpr.length; tcprr++){
                                const runn = {
                                    type: "Run",
                                    rPr: {
                                        fontSize: Number.parseInt(tcpr[tcprr]?.querySelector("rPr")?.querySelector("sz")?.getAttribute("w:val")) || Number.parseInt(tcpr[tcprr]?.querySelector("rPr")?.querySelector("szCs")?.getAttribute("w:val")),
                                        bold: tcpr[tcprr]?.querySelector("rPr")?.querySelector("b") || r?.querySelector("rPr")?.querySelector("bCs") ? true : false,
                                        italic: tcpr[tcprr]?.querySelector("rPr")?.querySelector("i") || r?.querySelector("rPr")?.querySelector("iCs") ? true : false,
                                        strike: tcpr[tcprr]?.querySelector("rPr")?.querySelector("strike") || r?.querySelector("rPr")?.querySelector("dstrike") ? true : false,
                                        underline: tcpr[tcprr]?.querySelector("rPr")?.querySelector("u") ? true : false,
                                        color: ""
                                    },
                                    oldValues: [] | ''
                                }

                                if (tcpr[tcprr]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val").startsWith("#")) {
                                    runn.rPr.color = tcpr[tcprr]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val");
                                } else if (tcpr[tcprr]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val") === undefined || tcpr[tcprr]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val") === null) {
                                    runn.rPr.color = "null";
                                } else {
                                    runn.rPr.color = `#${tcpr[tcprr]?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val")}`;
                                }
                                console.log(tcpr[tcprr]?.querySelectorAll("t"));
                                if (tcpr[tcprr]?.querySelectorAll("t").length > 1) {
                                    
                                    // for(let tp = 0; tp < tcpr[tcprr]?.querySelectorAll("t").length; tp++){
                                    //     runn.oldValues.push(tcpr[tcprr]?.querySelectorAll("t")[tp].textContent);
                                    // }
                                } else {
                                    console.log(tcpr[tcprr]?.querySelector("t"));
                                    // runn.oldValues = tcpr[tcprr]?.querySelector('t').textContent;
                                }

                                TableColumnParagraph.runs.push(runn);
                            }
                            tc.p.push(TableColumnParagraph);
                            console.log(tc.p);
                        }
                    }
                    tableRow.tcols.push(tc);
                }
                tablee.tbr.push(tableRow);
            }        
            return tablee
        }

        function createTable(pCC, el) {
            const table = document.createElement("table");
            const tableBody = document.createElement("tbody");
            el?.childNodes.forEach(tr => {
                if (tr.localName === 'tr') {
                    let tableRow = document.createElement("tr");
                    tr.childNodes.forEach(tc => {
                        if (tc.localName === 'tc') {
                            let tabEdit = document.createElement("td");
                            tabEdit.style.border = "1px solid #222222";
                            tabEdit.style.minHeight = "20px";
                            tc.childNodes.forEach(p => {
                                if (p.localName === 'p') {
                                    const paragraph = document.createElement("div");
                                    paragraph.style.display = "flex";
                                    paragraph.style.flexDirection = "row";
                                    paragraph.style.minHeight = "10px";
                                    p.childNodes.forEach(pr => {
                                        if (pr.localName === "r") {
                                            const run = document.createElement("pre");
                                            run.contentEditable = true;
                                            run.style.display = "inline";
                                            if (pr?.querySelector("rPr")?.querySelector("rFonts")) {
                                                run.style.fontFamily = pr?.querySelector("rPr")?.querySelector("rFonts").getAttribute("w:ascii") || 
                                                pr?.querySelector("rPr")?.querySelector("rFonts").getAttribute("w:hAnsi");
                                            }
                                            run.style.color = `#${pr?.querySelector("rPr")?.querySelector("color")?.getAttribute("w:val")}`;
                                            if (pr?.querySelector("rPr")?.querySelector("b") || pr?.querySelector("rPr")?.querySelector("bCs") ) {
                                                run.style.fontWeight = "600";
                                            }
                                            if (pr?.querySelector("rPr")?.querySelector("i") || pr?.querySelector("rPr")?.querySelector("iCs")) {
                                                run.style.fontStyle = "italic";
                                            }
                                            if (pr?.querySelector("rPr")?.querySelector("strike") || pr?.querySelector("rPr")?.querySelector("dstrike")
                                                && pr?.querySelector("rPr")?.querySelector("u")?.getAttribute("w:val")) {
                                                run.style.textDecoration = "underline line-through";

                                            }else if (pr?.querySelector("rPr")?.querySelector("u")?.getAttribute("w:val")) {
                                                run.style.textDecoration = "underline";
                                            } else if (pr?.querySelector("rPr")?.querySelector("strike") || pr?.querySelector("rPr")?.querySelector("dstrike")) {
                                                run.style.textDecoration = "line-through";
                                            }
                                            if (pr?.querySelector("rPr")?.querySelector("sz")?.getAttribute("w:val") == 22 || pr?.querySelector("rPr")?.querySelector("szCs")?.getAttribute("w:val") == 22) {
                                                run.style.fontSize = "14px";
                                            } else if (pr?.querySelector("rPr")?.querySelector("sz")?.getAttribute("w:val") == 48) {
                                                run.style.fontSize = "33px";
                                            }
                                            run.setAttribute("oldValue", pr?.querySelector("t")?.textContent);
                                            run.textContent = pr?.querySelector("t")?.textContent;
                                            run.addEventListener("click", (e) => {
                                                e.target.classList.toggle("kpaction");
                                            })
                                            run.addEventListener("focusout", (e) => {
                                                if (e.target.classList.value == "kpaction") {
                                                    e.target.classList.toggle("kpaction")
                                                }
                                            })
                                            run.addEventListener("input", (e) => {
                                                e.target.style.border = "1px solid #333333";
                                            })
                                            paragraph.appendChild(run);
                                        }
                                        tabEdit.appendChild(paragraph);
                                        }
                                    )
                                    tableRow.appendChild(tabEdit);
                                }
                            })
                        }
                    })
                    tableBody.appendChild(tableRow);
                }
            })
            table.appendChild(tableBody);
            pCC.appendChild(table);
        }

        function start(path, data) {
            let Documentt = {
                fileName: path.name,
                body: []
            }
            let mlDom = pars.parseFromString(data, 'application/xml');
            let mlDomBody = mlDom.querySelector("body");
            const edytorContainer = document.createElement('div');
            edytorContainer.classList.add('EditorContainer');
            const edytor = document.createElement('div');
            edytor.classList.add('Editor');
            for(const cN of mlDomBody.childNodes){
                if(cN.localName === 'p'){
                    PAndR(cN, edytor);
                } else if(cN.localName === 'tbl'){
                    createTable(edytor, cN);
                    vcccccccc(cN).then((result)=>{
                        Documentt.body.push(result);
                    })
                }
                edytorContainer.append(edytor);
                vbcx.append(edytorContainer);
            }
            console.log(Documentt.body);
        }
        
        dragg.addEventListener('dd', (e)=>{
            for(const files in e.detail.f){
                if(mFile.fileSystem.existsSync(`docxs/${e.detail.f[files].name}`)){
                    new DialogStart(vbcx, `${e.detail.f[files].name}`, e.detail.f, "Ile plików");
                }
            }
        })
    </script>
</body>
</html>